---
description: ì¼ì¼ íšŒê³  3íšŒì°¨
cover: .gitbook/assets/Frame 85 (1).png
coverY: 0
---

# ğŸ˜¢ 2024.07.26

## í• ì¼ ë° í•œì¼

* [x] íšŒì‚¬ ì—…ë¬´
  * [x] ì˜ìƒ ì…ë ¥ ì²˜ë¦¬ ì‹¤íŒ¨ í•´ê²°
* [x] ì‚¬ì´ë“œ í”„ë¡œì íŠ¸
  * [x] Spring Event í•™ìŠµ



## ê²½í—˜ ë° ë°°ì›€

### íšŒì‚¬ ì—…ë¬´

#### ì˜ìƒ ì…ë ¥ ì²˜ë¦¬ ì‹¤íŒ¨ í•´ê²°

íì‡„ë§ í™˜ê²½ì˜ ê¸°ê´€ì— ë‚©í’ˆë˜ì–´ ìˆëŠ” ì‹œìŠ¤í…œì—ì„œ ì˜ìƒì„ ì…ë ¥í•˜ë‹¤ê°€ ì‹¤íŒ¨í–ˆë‹¤ëŠ” ì–˜ê¸°ë¥¼ ì „ë‹¬ë°›ì•˜ë‹¤. ë‘ Geometry íƒ€ì…ì˜ ê°ì²´ë¥¼ intersection í–ˆì„ ë•Œ self-intersection ì´ ë˜ì–´ ìˆëŠ” ê²½ìš° ë°œìƒí•˜ëŠ” ì—ëŸ¬ì˜€ìœ¼ë©° ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```kotlin
Exception in thread "main" org.locationtech.jts.geom.TopologyException: found non-noded intersection between LINESTRING ( 120.65259965054962 31.285279777143465, 120.67974663557145 31.288251142146198 ) and LINESTRING ( 120.65273638403228 31.28526053475525, 120.6525866745773 31.28529679390149 ) [ (120.65263910444314, 31.2852840955574, NaN) ]
	at org.locationtech.jts.noding.FastNodingValidator.checkValid(FastNodingValidator.java:139)
	at org.locationtech.jts.geomgraph.EdgeNodingValidator.checkValid(EdgeNodingValidator.java:80)
	at org.locationtech.jts.geomgraph.EdgeNodingValidator.checkValid(EdgeNodingValidator.java:45)
	at org.locationtech.jts.operation.overlay.OverlayOp.computeOverlay(OverlayOp.java:229)
	at org.locationtech.jts.operation.overlay.OverlayOp.getResultGeometry(OverlayOp.java:181)
	at org.locationtech.jts.operation.overlay.OverlayOp.overlayOp(OverlayOp.java:84)
	at org.locationtech.jts.operation.overlay.snap.SnapIfNeededOverlayOp.getResultGeometry(SnapIfNeededOverlayOp.java:75)
	at org.locationtech.jts.operation.overlay.snap.SnapIfNeededOverlayOp.overlayOp(SnapIfNeededOverlayOp.java:37)
	at org.locationtech.jts.geom.GeometryOverlay.overlay(GeometryOverlay.java:76)
	at org.locationtech.jts.geom.GeometryOverlay.intersection(GeometryOverlay.java:119)
	at org.locationtech.jts.geom.Geometry.intersection(Geometry.java:1330)
	at org.jetbrains.kotlin.idea.scratch.generated.ScratchFileRunnerGenerated$ScratchFileRunnerGenerated.<init>(tmp.kt:15)
	at org.jetbrains.kotlin.idea.scratch.generated.ScratchFileRunnerGenerated.main(tmp.kt:20)
```



ìœ„ ì—ëŸ¬ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ì¼€ì´ìŠ¤ë¥¼ ì°¾ì•„ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ í•´ê²°í•˜ëŠ” ì‘ì—…ì„ ì™„ë£Œí–ˆì—ˆë‹¤.

```kotlin
import com.sia.inference.util.tryToMultiPolygon
import org.locationtech.jts.geom.GeometryFactory
import org.locationtech.jts.io.WKTReader

// JTS GeometryFactory ì´ˆê¸°í™”
val geometryFactory = GeometryFactory()

val polygon1 =
    WKTReader().read("MULTIPOLYGON (((120.65259965054962 31.285279777143465, 120.67974663557145 31.288251142146198, 120.68831455911376 31.28918923620673, 120.70794961491976 31.282636365231323, 120.76374886330346 31.283832422390343, 120.78566214063716 31.282849157114605, 120.78727475541889 31.282211626764653, 120.7870154283358 31.28112971510409, 120.78159715214149 31.281396505875275, 120.7675993122942 31.282369818420804, 120.76620314875765 31.281048292763057, 120.7622268383381 31.282310090290256, 120.75562997396135 31.281939054121096, 120.74886389782327 31.28171655444499, 120.74540558497365 31.28169741706209, 120.73917835062895 31.28125748233043, 120.73308266356383 31.281259760653278, 120.70952760230696 31.279938436718577, 120.70172330921004 31.281048754102418, 120.690769367383 31.283502308101333, 120.68806834503596 31.285431202279767, 120.67784877635694 31.28510197877543, 120.66475600163066 31.284907044197734, 120.65301591965225 31.28423244481776, 120.65273638403228 31.28526053475525, 120.6525866745773 31.28529679390149, 120.6525866745773 31.28529679390149, 120.65259965054962 31.285279777143465)))").tryToMultiPolygon()
        .buffer(0.0)

// ë‘ ë²ˆì§¸ Polygon ìƒì„± (ì‚¬ê°í˜•ì´ êµì°¨í•˜ëŠ” í˜•íƒœ)
val polygon2 =
    WKTReader().read("MULTIPOLYGON (((120.69573564330616 31.327309999189573, 120.69612595247793 31.327308370013657, 120.69718722428661 31.325717255890233, 120.69808270409025 31.325368971486622, 120.70169963540822 31.325569380113155, 120.70516017403206 31.325597389289385, 120.70689764247813 31.324660350571925, 120.75542191932003 31.329295587119677, 120.75550805594263 31.328123043584245, 120.72823987922153 31.325796147944697, 120.70711040566125 31.323744401744424, 120.70573841638927 31.324149119597184, 120.70488267408774 31.32470010686361, 120.69776330474302 31.32476569478398, 120.69647748854426 31.325444487565747, 120.69566285003579 31.326380456642895, 120.69573564330616 31.327309999189573)))").tryToMultiPolygon()
        .buffer(0.0)

// ë‘ Polygonì˜ êµì°¨ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
val intersection = polygon1.intersection(polygon2)

```

```kotlin
POLYGON EMPTY
```

<details>

<summary>buffer(0.0) ??</summary>

ì½”ë“œì—ì„œ `buffer(0.0)`ì„ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì€ JTS (Java Topology Suite) ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ **`Geometry`** ê°ì²´ì— ëŒ€í•´ ë²„í¼ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.   **`buffer()`** ë©”ì„œë“œëŠ” ì£¼ì–´ì§„ ì§€ì˜¤ë©”íŠ¸ë¦¬ ì£¼ë³€ì— ì§€ì •ëœ ê±°ë¦¬ë§Œí¼ì˜ ë²„í¼ ì˜ì—­ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ ê²½ìš°, ë²„í¼ ê±°ë¦¬ë¡œ `0.0`ì´ ì§€ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

#### **`buffer(0.0)`ì˜ ëª©ì ê³¼ ì‘ë™ ì›ë¦¬:**

* **ëª©ì **: `buffer(0.0)`ì„ ì‚¬ìš©í•˜ëŠ” ì£¼ëœ ëª©ì ì€ ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ ê°„ì†Œí™”(simplification) ë˜ëŠ” ì •ê·œí™”(normalization)ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì‘ì€ ê¸°í•˜í•™ì  ë¶ˆê·œì¹™ì„±ì´ë‚˜ ìê¸° êµì°¨(self-intersections) ê°™ì€ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¬¸ì œë“¤ì€ ì¢…ì¢… ì§€ì˜¤ë©”íŠ¸ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê±°ë‚˜ ê³µê°„ ë¶„ì„ì„ ìˆ˜í–‰í•  ë•Œ ì˜¤ë¥˜ì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.
* **ì‘ë™ ì›ë¦¬**: **`buffer(0.0)`** í˜¸ì¶œì€ ì§€ì˜¤ë©”íŠ¸ë¦¬ì— 0ì˜ ê±°ë¦¬ë§Œí¼ ë²„í¼ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. ì¦‰, ì‹¤ì œë¡œ ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ í¬ê¸°ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ê³¼ì •ì—ì„œ JTS ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŠ” ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ ë¶ˆê·œì¹™ì„±ì„ ì œê±°í•˜ê³ , ê¹¨ë—í•˜ê³  ì •í™•í•œ ì§€ì˜¤ë©”íŠ¸ë¦¬ í‘œí˜„ì„ í™•ë³´í•˜ëŠ” íš¨ê³¼ê°€ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, ìê¸° êµì°¨ë‚˜ ë§¤ìš° ê°€ê¹Œìš´ ì„ ë¶„ë“¤ì´ ì„œë¡œ 'ìŠ¤ëƒ…(snap)'ë˜ì–´ ë” ì¼ê´€ì„± ìˆëŠ” êµ¬ì¡°ë¡œ ì •ë ¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### **ì‚¬ìš© ì‚¬ë¡€:**

* **ìê¸° êµì°¨ ì œê±°**: í´ë¦¬ê³¤ì´ë‚˜ ë¼ì¸ìŠ¤íŠ¸ë§ì´ ìê¸° ìì‹ ê³¼ êµì°¨í•˜ëŠ” ê²½ìš°, ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ì‘ì€ ë¶ˆê·œì¹™ì„± ìˆ˜ì •**: ì§€ì˜¤ë©”íŠ¸ë¦¬ì˜ ê²½ê³„ì— ë§¤ìš° ì‘ì€ ë¶ˆê·œì¹™ì„±ì´ ìˆì„ ë•Œ, ì´ë¥¼ í‰í™œí™”í•˜ì—¬ ë³´ë‹¤ ì •ê·œí™”ëœ í˜•íƒœë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ë¡œë²„ìŠ¤íŒ…(robustness) í–¥ìƒ**: ê³µê°„ ì—°ì‚° ì¤‘ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‘ì€ ì˜¤ë¥˜ë‚˜ ë¶ˆì•ˆì •ì„±ì„ ì¤„ì—¬, ì—°ì‚°ì˜ ì•ˆì •ì„±ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`buffer(0.0)`ëŠ” ì§€ì˜¤ë©”íŠ¸ë¦¬ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì§€ì˜¤ë©”íŠ¸ë¦¬ë¥¼ 'ì •ë¦¬'í•˜ê³ , ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì„ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ëª¨ë“  ê²½ìš°ì— ì´ ë°©ë²•ì´ ì í•©í•œ ê²ƒì€ ì•„ë‹ˆë©°, íŠ¹íˆ í° ì§€ì˜¤ë©”íŠ¸ë¦¬ ë°ì´í„°ì…‹ì„ ì²˜ë¦¬í•  ë•ŒëŠ” ì„±ëŠ¥ ì €í•˜ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

</details>



í•˜ì§€ë§Œ ë™ì¼í•˜ê²Œ ë¬¸ì œê°€ ë°œìƒë˜ì–´ ê¸°ê´€ìœ¼ë¡œ ì¶œì¥ê°€ì‹  ê°œë°œìë¶„ì—ê²Œ í™•ì¸ì„ ìš”ì²­í–ˆìœ¼ë‚˜ ì •í™•í•œ ë¬¸ì œë¥¼ ì•Œì•„ë‚´ì§€ ëª» í•˜ì…¨ë‹¤. ì–´ë–¤ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ì„œ í˜¸ì¶œí–ˆì„ ë•Œ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ë¬¸ì œ í•´ê²°ì„ ì§„í–‰í–ˆë‹¤.

intersectionì„ ìˆ˜í–‰í•˜ê¸° ì „ì— Geometryê°€ ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš° buffor(0.0)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°’ì„ ë³€í™˜í•œ í›„ì— intersection í•˜ë„ë¡ ìˆ˜ì •í–ˆì—ˆë‹¤. ì´ ë¶€ë¶„ì´ ë¬¸ì œê°€ ë°œìƒí•˜ë¯€ë¡œ í•´ë‹¹ ê¸°ëŠ¥ì„ PostGISë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬ë˜ë„ë¡ ë³€ê²½ì„ ì§„í–‰í–ˆë‹¤.

ë‹¤ìŒ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ intersectionì„ ìˆ˜í–‰í•˜ë„ë¡ ë³€ê²½í•œ í›„ì— í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ê²€ì¦í•˜ê³ , ë„ì»¤ ì´ë¯¸ì§€ë¥¼ í…ŒìŠ¤íŠ¸ ì„œë²„ì— ë°°í¬í•˜ì—¬ ì˜ìƒì„ ë„£ì—ˆì„ ë•Œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤.

```sql
select st_intersection(
    st_makevalid(:geometry1), 
    st_makevalid(:geometry2)
) as geometry
```



ë‹¤ìŒì£¼ ì›”ìš”ì¼ì— ì–´ë–¤ ë°ì´í„°ê°€ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•œ í›„ì— í•´ë‹¹ ë°ì´í„°ê°€ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ì •ìƒë™ì‘ í•˜ëŠ”ì§€ ê²€ì¦í•˜ê³  ì„œë²„ë¥¼ ì—…ë°ì´íŠ¸ í•  ì˜ˆì •ì´ë‹¤. ì˜ ë§ˆë¬´ë¦¬ ë˜ê¸¸ ë¹ˆë‹¤..



### ê°œì¸ í”„ë¡œì íŠ¸

#### Spring Events í•™ìŠµ

ì–´ì œ í•´ê²°ì„ ì§„í–‰í•˜ë˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì´ì–´ì„œ ì‚´í´ë´¤ë‹¤.

```kotlin
@IntegrationTest
class CustomSpringEventPublisherTest @Autowired constructor(
    val eventPublisher: CustomSpringEventPublisher,
) {

    @MockBean
    lateinit var eventConsumer: AnnotationDrivenEventListener

    @Captor
    lateinit var captor: ArgumentCaptor<CustomSpringEvent>

    @Test
    fun `ì‚¬ìš©ì ì •ì˜ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•  ìˆ˜ ìˆë‹¤`(): Unit = runBlocking {
        val expected = "message"
        eventPublisher.publishCustomEvent(expected)
        verify(eventConsumer, times(1)).handleCustomEvent(captor.capture())
        val actual = captor.value
        assertThat(actual).isEqualTo(expected)
    }
}
```



## ê°œì„  ë° ëª©í‘œ



